"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const pm = require("picomatch");
const util_1 = require("util");
const log = util_1.debuglog('midway:glob');
exports.run = (pattern, options = { cwd: process.cwd(), ignore: [] }) => {
    const startTime = Date.now();
    const entryDir = options.cwd;
    const isMatch = pm(pattern, {
        ignore: options.ignore || []
    });
    const ignoreMatch = pm('**', {
        ignore: options.ignore || []
    });
    function globDirectory(dirname, isMatch, ignoreDirMatch, options) {
        if (!fs_1.existsSync(dirname)) {
            return [];
        }
        const list = fs_1.readdirSync(dirname);
        const result = [];
        for (let file of list) {
            const resolvePath = path_1.resolve(dirname, file);
            log(`resolvePath = ${resolvePath}`);
            const fileStat = fs_1.statSync(resolvePath);
            if (fileStat.isDirectory() && ignoreDirMatch(resolvePath.replace(entryDir, ''))) {
                const childs = globDirectory(resolvePath, isMatch, ignoreDirMatch, options);
                result.push(...childs);
            }
            else if (fileStat.isFile() && isMatch(resolvePath.replace(entryDir, ''))) {
                result.push(resolvePath);
            }
        }
        return result;
    }
    const result = globDirectory(entryDir, isMatch, ignoreMatch, options);
    log(`midway glob timing ${Date.now() - startTime}ms`);
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkJBQXVEO0FBQ3ZELCtCQUErQjtBQUMvQixnQ0FBZ0M7QUFDaEMsK0JBQWdDO0FBRWhDLE1BQU0sR0FBRyxHQUFHLGVBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQU92QixRQUFBLEdBQUcsR0FBRyxDQUFDLE9BQWlCLEVBQUUsVUFBc0IsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFO0lBQ2pHLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQzdCLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUU7UUFDMUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRTtLQUM3QixDQUFDLENBQUM7SUFDSCxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFO1FBQzNCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxJQUFJLEVBQUU7S0FDN0IsQ0FBQyxDQUFBO0lBRUYsU0FBUyxhQUFhLENBQUMsT0FBZSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsT0FBUTtRQUN2RSxJQUFJLENBQUMsZUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3hCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxNQUFNLElBQUksR0FBRyxnQkFBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVsQixLQUFLLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNyQixNQUFNLFdBQVcsR0FBRyxjQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzNDLEdBQUcsQ0FBQyxpQkFBaUIsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUNwQyxNQUFNLFFBQVEsR0FBRyxhQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDdkMsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLElBQUksY0FBYyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQy9FLE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDNUUsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNLElBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFO2dCQUN6RSxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzFCO1NBQ0Y7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RFLEdBQUcsQ0FBQyxzQkFBc0IsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsSUFBSSxDQUFDLENBQUM7SUFDdEQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFBIn0=